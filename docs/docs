param(
    [string]$Path = "..\app",
    [switch]$Recursive = $true,
    [int]$Debounce = 2000
)

$ParserScript = "08_PARSER.ps1"
$Extensions = @(".php", ".vue", ".js", ".jsx", ".ts", ".tsx")
$ExcludePaths = @("node_modules", "vendor", ".git", "storage", "bootstrap/cache", "public/build")

$PendingFiles = @{}
$ProcessedCount = 0
$ErrorCount = 0

function Write-Success { param($m) Write-Host "[OK] $m" -ForegroundColor Green }
function Write-Error-Custom { param($m) Write-Host "[ERROR] $m" -ForegroundColor Red }
function Write-Info { param($m) Write-Host "[INFO] $m" -ForegroundColor Cyan }
function Write-Warning-Custom { param($m) Write-Host "[WARN] $m" -ForegroundColor Yellow }

function Test-ShouldProcess {
    param([string]$FilePath)
    
    $ext = [System.IO.Path]::GetExtension($FilePath)
    if ($ext -notin $Extensions) { return $false }
    
    foreach ($exclude in $ExcludePaths) {
        if ($FilePath -like "*$exclude*") { return $false }
    }
    
    return $true
}

function Invoke-ProcessFile {
    param([string]$FilePath)
    
    if (!(Test-ShouldProcess -FilePath $FilePath)) { return }
    
    Write-Host ""
    Write-Host "===========================================" -ForegroundColor DarkGray
    Write-Info "Processing: $FilePath"
    
    try {
        $result = & ".\$ParserScript" -File $FilePath 2>&1
        Write-Host $result
        
        $Script:ProcessedCount++
        Write-Success "File processed successfully"
        
    } catch {
        $Script:ErrorCount++
        Write-Error-Custom "Error processing file: $_"
    }
    
    Write-Host "===========================================" -ForegroundColor DarkGray
}

function Register-FileChange {
    param([string]$FilePath)
    
    if ($Script:PendingFiles.ContainsKey($FilePath)) {
        $Script:PendingFiles[$FilePath].Dispose()
    }
    
    $timer = New-Object System.Timers.Timer
    $timer.Interval = $Debounce
    $timer.AutoReset = $false
    
    $action = {
        param($source, $e)
        $file = $source.Tag
        Invoke-ProcessFile -FilePath $file
        $Script:PendingFiles.Remove($file)
        $source.Dispose()
    }
    
    Register-ObjectEvent -InputObject $timer -EventName Elapsed -Action $action | Out-Null
    
    $timer.Tag = $FilePath
    $Script:PendingFiles[$FilePath] = $timer
    $timer.Start()
    
    Write-Host "[WAIT] File detected (debouncing $Debounce ms): $FilePath" -ForegroundColor DarkGray
}

$onChanged = {
    param($source, $e)
    if ($e.ChangeType -eq "Changed") {
        Register-FileChange -FilePath $e.FullPath
    }
}

$onError = {
    param($source, $e)
    Write-Error-Custom "Watcher error: $($e.GetException())"
}

function Show-Status {
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host "  WATCHER STATUS" -ForegroundColor Cyan
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host "  Files processed: $Script:ProcessedCount" -ForegroundColor Cyan
    Write-Host "  Errors:          $Script:ErrorCount" -ForegroundColor Cyan
    Write-Host "  Pending:         $($Script:PendingFiles.Count)" -ForegroundColor Cyan
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host ""
}

function Stop-Watcher {
    param($Watcher)
    
    Write-Info "Stopping watcher..."
    
    if ($Watcher) {
        $Watcher.EnableRaisingEvents = $false
        $Watcher.Dispose()
    }
    
    foreach ($timer in $Script:PendingFiles.Values) {
        $timer.Dispose()
    }
    $Script:PendingFiles.Clear()
    
    Get-EventSubscriber | Where-Object { $_.SourceObject -is [System.IO.FileSystemWatcher] } | Unregister-Event
    
    Write-Success "Watcher stopped"
}

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  METADATA WATCHER v2.0" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Configuration:" -ForegroundColor Yellow
Write-Host "  Path:       $Path" -ForegroundColor White
Write-Host "  Recursive:  $Recursive" -ForegroundColor White
Write-Host "  Debounce:   $Debounce ms" -ForegroundColor White
Write-Host "  Extensions: $($Extensions -join ", ")" -ForegroundColor White
Write-Host "  Parser:     $ParserScript" -ForegroundColor White
Write-Host ""

if (!(Test-Path $ParserScript)) {
    Write-Error-Custom "Parser not found: $ParserScript"
    exit 1
}

if (!(Test-Path $Path)) {
    Write-Error-Custom "Path not found: $Path"
    exit 1
}

try {
    $watcher = New-Object System.IO.FileSystemWatcher
    $watcher.Path = $Path
    $watcher.IncludeSubdirectories = $Recursive
    $watcher.EnableRaisingEvents = $true
    $watcher.Filter = "*.*"
    $watcher.NotifyFilter = [System.IO.NotifyFilters]::FileName -bor [System.IO.NotifyFilters]::LastWrite
    
    Register-ObjectEvent -InputObject $watcher -EventName Changed -Action $onChanged | Out-Null
    Register-ObjectEvent -InputObject $watcher -EventName Error -Action $onError | Out-Null
    
    Write-Success "Watcher started successfully"
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Green
    Write-Host "  WATCHER ACTIVE - Monitoring changes" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
    Write-Host ""
    Write-Host "Instructions:" -ForegroundColor Yellow
    Write-Host "  1. Save files with @meta blocks" -ForegroundColor White
    Write-Host "  2. Watcher detects automatically" -ForegroundColor White
    Write-Host "  3. Parser processes changes" -ForegroundColor White
    Write-Host "  4. MASTER.md updates automatically" -ForegroundColor White
    Write-Host ""
    Write-Host "Controls:" -ForegroundColor Yellow
    Write-Host "  [S] - Show status" -ForegroundColor White
    Write-Host "  [Q] - Quit" -ForegroundColor White
    Write-Host ""
    Write-Host "Waiting for changes..." -ForegroundColor Cyan
    Write-Host ""
    
    while ($true) {
        if ([Console]::KeyAvailable) {
            $key = [Console]::ReadKey($true)
            
            switch ($key.Key) {
                "S" { Show-Status }
                "Q" { 
                    Write-Info "Quitting..."
                    break 
                }
            }
            
            if ($key.Key -eq "Q") { break }
        }
        
        Start-Sleep -Milliseconds 100
    }
    
} catch {
    Write-Error-Custom "Error starting watcher: $_"
    exit 1
    
} finally {
    Stop-Watcher -Watcher $watcher
    
    Write-Host ""
    Write-Host "========================================" -ForegroundColor Green
    Write-Host "  SESSION SUMMARY" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
    Write-Host "  Files processed: $Script:ProcessedCount" -ForegroundColor Green
    Write-Host "  Errors:          $Script:ErrorCount" -ForegroundColor Green
    Write-Host "========================================" -ForegroundColor Green
    Write-Host ""
    
    Write-Success "Watcher finished. Goodbye!"
}
